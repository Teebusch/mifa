---
output: github_document
editor_options: 
  markdown: 
    wrap: 80
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

set.seed(1234)
```

# mifa

<!-- badges: start -->

[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![R build status](https://github.com/teebusch/mifa/workflows/R-CMD-check/badge.svg)](https://github.com/teebusch/mifa/actions)
<!-- badges: end -->

`mifa` implements multiple imputation for exploratory factor analysis.
It uses multiple imputation by chained equations (MICE) to estimate the 
covariance matrix of the incomplete data. An exploratory factor analysis then 
can be applied on this estimated covariance matrix. It also provides Fieller and 
bootstrap confidence intervals for the proportion of explained variance using 
different numbers of factors.

**For more information, see:**

Nassiri, V., Lovik, A., Molenberghs, G. *et al.* On using multiple imputation
for exploratory factor analysis of incomplete data. *Behav Res* 50, 501â€“517
(2018). <https://doi.org/10.3758/s13428-017-1013-4>

## Installation

You can install the the release version of mifa from
[GitHub](https://github.com/) with:

```r
# install.packages("devtools")
devtools::install_github("vahidnassiri/mifa")
```

## Usage

In this example, we use the `bfi` data set from the `psych` package. It contains 
data from 2800 subjects: Their answers to 25 personality self report items and 
3 demographic variables (sex, education, and age). 

The 25 columns with responses to personality questions are already grouped into 
5 personality factors, as indicated by their names:

* **A1-A5** Agreeableness)
* **C1-C5** Conscientiousness) 
* **E1-E5** Extraversion)
* **N1-N5** Neuroticism)
* **O1-O5** Openness)

In most columns there are a couple of missing values.

```{r}
library(psych)
colSums(is.na(bfi))
```
We can use `mifa` to impute the missing values multiple times using Multivariate
Imputation with Chained Equations (MICE). Then we can obtain a covariance matrix
for each imputed data set and combine these estimates into a single estimated 
covariance matrix on which we can then perform exploratory factor analyis:

```{r run-mifa, messages=FALSE}

library(mifa)

data <- bfi[, 1:25] # exclude gender, education, and age

mi <- mifa.cov(data, n.factor = 2:8, M = 5, maxit.mi = 5, method.mi = "pmm",
               alpha = 0.05, rep.boot = 50, ci = TRUE)

summary(mi)
```

The Fieller confidence intervals indicate that 5 factors are enough to explain 
more than half of the variance:

```{r}
round(mi$ci.mice.fieller, 2)
```

The bootstrapped confidence intervals also confirm this:

```{r}
round(mi$ci.mice.bootstrap, 2)
```
 
The estimated covariance matrix based on imputed data is in `result.mi$cov.mice`, 
and we can use it to perform exploratory factor analysis with the desired number
of factors. We use the `fa()` function from `psych` for this:

```{r}
fit <- fa(r = mi$cov.mice, n.obs = nrow(data), nfactors = 5, rotate = "varimax")
fit
```

The plot below shows that the five factors have been recovered quite well:

```{r}
fa.diagram(fit)
```
We can extract the factor scores and add them to the original data:

```{r fig.height=3, fig.width=8}

# use a single imputation (predi)
imp <- mice::mice(bfi, m = 1, print = FALSE)
data_imp <- mice::complete(imp, 1)
fct_scores <- data.frame(factor.scores(data_imp[, 1:25], fit)$scores)

data_imp <- data.frame(
  Gender        = factor(data_imp$gender),
  Age           = data_imp$age,
  Extraversion  = fct_scores$MR1,
  Neuroticism   = fct_scores$MR2,
  Conciousness  = fct_scores$MR3,
  Openness      = fct_scores$MR4,
  Agreeableness = fct_scores$MR5
)

levels(data_imp$Gender) <- c("Male", "Female")
```

```{r fig.height=3, fig.width=8}
library(ggplot2)
library(tidyr)

data_imp <- tidyr::pivot_longer(data_imp, -c("Gender", "Age"), "factor")

ggplot(data_imp, aes(value, linetype = Gender)) +
  geom_density() +
  facet_wrap(~ factor, nrow = 1)
```

```{r fig.height=10}
ggplot(data_imp, aes(Age, value)) +
  geom_point(alpha = .1, position = position_jitter(width = .4)) +
  geom_smooth(color = "dodgerblue") +
  facet_wrap(~ factor, ncol = 2) +
  coord_cartesian(xlim = c(16, 65))
```

