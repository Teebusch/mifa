---
output: github_document
editor_options: 
  markdown: 
    wrap: 80
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

set.seed(1234)
```

# mifa

<!-- badges: start -->

[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![R build status](https://github.com/teebusch/mifa/workflows/R-CMD-check/badge.svg)](https://github.com/teebusch/mifa/actions)
[![Codecov test coverage](https://codecov.io/gh/Teebusch/mifa/branch/master/graph/badge.svg)](https://codecov.io/gh/Teebusch/mifa?branch=master)
<!-- badges: end -->

`mifa` implements multiple imputation for exploratory factor analysis to allow
performing exploratory factor analysis on data sets with missing data. It works
as follows:


* `mifa` imputes the missing values multiple times using Multivariate
Imputation with Chained Equations (MICE) from the [mice package](https://amices.org/mice/).

* It then combines the covariance matrices of the imputed data sets into a single
estimated covariance matrix using Rubin's rules. 

* This combined covariance matrix can then be used to perform exploratory factor 
analyis.

* `mifa` also provides two types of confidence intervals for the
variance explained by different numbers of factors: Parametric Fieller 
confidence intervals for larger samples, and nonparametric bootstrapped 
confidence intervals for smaller samples.

**For more information, see:**

Nassiri, V., Lovik, A., Molenberghs, G., Verbeke, G. (2018) On using multiple 
imputation for exploratory factor analysis of incomplete data. 
*Behavior Research Methods* 50, 501â€“517. 
<https://doi.org/10.3758/s13428-017-1013-4>

## Installation

You can install the the developmental version of `mifa` with:

You can install the the release version of `mifa` from
[GitHub](https://github.com/teebusch/mifa) with:

```r
# install.packages("devtools")
devtools::install_github("teebusch/mifa")
```

```r
# install.packages("devtools")
devtools::install_github("teebusch/mifa@dev")
```

The original version of mifa appears to have been abandoned by the author. 
You can find it [here](https://github.com/vahidnassiri/mifa).


## Usage

As an example, we use the `bfi` data set from the `psych` package. It contains 
data from 2800 subjects: Their answers to 25 personality self report items and 
3 demographic variables (sex, education, and age). 

The 25 columns with responses to personality questions correspond to 5 putative
personality factors, as indicated by their names: Agreeableness,
Conscientiousness, Extraversion, Neuroticism, Openness.

In most columns there are a couple of missing values.

```{r}
library(psych)
data <- bfi[, 1:25] # exclude gender, education, and age
colSums(is.na(data))
```

We use `mifa()` to get the corariance matrix.

```{r run-mifa, messages=FALSE}
library(mifa)
mi <- mifa(data, n_factors = 2:8, ci = "both", n_boot = 50, print = FALSE)

summary(mi)
```

Both, the Fieller and bootstrap 95% confidence intervals indicate that 5 factors
are enough to explain more than half of the variance:

```{r}
round(mi$var_explained, 2)
```

The estimated covariance matrix based on imputed data is in `mi$cov_combined`, 
and we can use it to perform exploratory factor analysis with the desired number
of factors. We use the `fa()` function from `psych` for this:

```{r}
fit <- fa(r = mi$cov_combined, n.obs = nrow(data), nfactors = 5, 
          rotate = "varimax")
fit
```

The plot below shows that the five factors have been recovered quite well:

```{r fig.width=10, fig.height=7, fig.retina=T}
fa.diagram(fit)
```

We can extract the factor scores, add them to the original data, and visualize
them:

```{r}

# impute a single data set with mice
imp <- mice::mice(bfi, m = 1, print = FALSE)
data_imp <- mice::complete(imp, 1)

# get factor scores for original data
fct_scores <- data.frame(factor.scores(data_imp[, 1:25], fit)$scores)

data_imp <- data.frame(
  Gender        = factor(data_imp$gender),
  Extraversion  = fct_scores$MR1,
  Neuroticism   = fct_scores$MR2,
  Conscientious = fct_scores$MR3,
  Openness      = fct_scores$MR4,
  Agreeableness = fct_scores$MR5
)

levels(data_imp$Gender) <- c("Male", "Female")
```

```{r include = FALSE}
library(ggplot2)
ggplot2::theme_set(theme_minimal(base_size = 16))
```

```{r fig.width=10, fig.height=6, fig.retina=TRUE}
library(ggplot2)
library(tidyr)

data_imp <- tidyr::pivot_longer(data_imp, -Gender, "factor")

ggplot(data_imp, aes(value, linetype = Gender)) +
  geom_density() +
  facet_wrap(~ factor, nrow = 2) +
  theme(legend.position = c(.9, .1))
```
