---
output: github_document
editor_options: 
  markdown: 
    wrap: 80
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

set.seed(1234)
```

# mifa

<!-- badges: start -->

[![Lifecycle:
experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![R build
status](https://github.com/teebusch/mifa/workflows/R-CMD-check/badge.svg)](https://github.com/teebusch/mifa/actions)
[![Codecov test
coverage](https://codecov.io/gh/Teebusch/mifa/branch/master/graph/badge.svg)](https://codecov.io/gh/Teebusch/mifa?branch=master)

<!-- badges: end -->

`mifa` implements multiple imputation of covariance matrices to allow
exploratory factor analyis of incomplete data.

It works as follows:

1.  Impute missing values multiple times using *Multivariate Imputation with
    Chained Equations* (MICE) from the [mice package](https://amices.org/mice/).

2.  Combine the covariance matrices of the imputed data sets into a single
    covariance matrix using Rubin's rules^[Rubin D. B. Multiple imputation for
    nonresponse in surveys (2004). John Wiley & Sons].

3.   Use the combined covariance matrix for exploratory factor analysis.

`mifa` also provides two types of confidence intervals for the variance
explained by different numbers of principal components:

-   Fieller confidence intervals (parametric) for larger samples^[Fieller, E. C.
    (1954). Some problems in interval estimation. Journal of the Royal
    Statistical Society. Series B (Methodological): 175-185.]

-   Bootstrapped confidence intervals (nonparametric) for smaller
    samples^[Shao, J. & Sitter, R. R. (1996). Bootstrap for imputed survey data.
    Journal of the American Statistical Association 91.435 (1996): 1278-1288.
    <https://dx.doi.org/10.1080/01621459.1996.10476997>]

#### Reference for mifa

Nassiri, V., Lovik, A., Molenberghs, G., Verbeke, G. (2018) On using multiple
imputation for exploratory factor analysis of incomplete data. *Behavior
Research Methods* 50, 501â€“517. <https://doi.org/10.3758/s13428-017-1013-4>

*Note:* The paper was accompanied by an implementation of `mifa` appears to have
been abandoned by the author. You can find it
[here](https://github.com/vahidnassiri/mifa).

## Installation

You can install the the stable release version of `mifa` from
[GitHub](https://github.com/teebusch/mifa) with:

``` r
# install.packages("devtools")
devtools::install_github("teebusch/mifa")
```

You can also install the the developmental version of `mifa` with:

``` r
# install.packages("devtools")
devtools::install_github("teebusch/mifa@dev")
```

## Usage

As an example, we use the `bfi` data set from the `psych` package. It contains
2,800 subjects' answers to 25 personality self-report items and 3 demographic
variables (sex, education, and age). The 25 columns with responses to
personality questions correspond to 5 putative personality factors, as indicated
by their names: **A**greeableness, **C**onscientiousness, **E**xtraversion,
**N**euroticism, **O**penness. There are missing responses for most items.

First, we use `mifa()` to impute the covariance matrix and get an idea how many
factors we should use:

```{r run-mifa, messages=FALSE}
library(mifa)
library(psych)

mi <- mifa(
  data      = bfi, 
  cov_vars  = -c(gender, education, age),
  n_factors = 2:8, 
  ci        = "fieller", 
  print     = FALSE
)

summary(mi)
```

It looks like 5 factors explain more than half of the variance, so we perform a
factor analysis with 5 factors, using the `fa()` function from the `psych`
package.

```{r}
fit <- fa(
  mi$cov_combined, 
  n.obs     = nrow(bfi), 
  nfactors  = 5, 
  rotate    = "varimax"
)

fit
```

The plot below shows that the five factors have been recovered quite well:

```{r fig.width=10, fig.height=7, fig.retina=T}
fa.diagram(fit)
```

Once we have the estimated covariance matrix, we can perform a factor analysis
as usual. For example, we can add the factor scores to the original data, and
visualize them:

```{r}

# impute a single data set with mice, so we can obtain factor scores for inclomplete cases
data_imp <- mice::complete(mice::mice(bfi, 1, print = FALSE))

# get factor scores for original data
fct_scores <- data.frame(factor.scores(data_imp[, 1:25], fit)$scores)

data_imp <- data.frame(
  Gender        = factor(data_imp$gender),
  Extraversion  = fct_scores$MR1,
  Neuroticism   = fct_scores$MR2,
  Conscientious = fct_scores$MR3,
  Openness      = fct_scores$MR4,
  Agreeableness = fct_scores$MR5
)

levels(data_imp$Gender) <- c("Male", "Female")
```

```{r include = FALSE}
library(ggplot2)
ggplot2::theme_set(theme_minimal(base_size = 16))
```

```{r fig.width=10, fig.height=6, fig.retina=TRUE}
library(ggplot2)
library(tidyr)

data_imp <- tidyr::pivot_longer(data_imp, -Gender, "factor")

ggplot(data_imp, aes(value, linetype = Gender)) +
  geom_density() +
  facet_wrap(~ factor, nrow = 2) +
  theme(legend.position = c(.9, .1))
```
